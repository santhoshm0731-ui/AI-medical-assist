{% extends 'base.html' %}
{% block title %}Admin Analytics Dashboard{% endblock %}
{% block content %}

<style>
  body {
    background: radial-gradient(circle at top left, #e0f7fa 0%, #f9fafb 40%, #e0e7ff 85%);
    font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    overflow-x: hidden;
  }

  .admin-page {
    min-height: calc(100vh - 80px);
    padding: 28px 10px 40px;
  }

  .admin-shell {
    max-width: 1180px;
    margin: 0 auto;
    background: rgba(255,255,255,0.97);
    border-radius: 24px;
    box-shadow: 0 22px 55px rgba(15,23,42,0.18);
    border: 1px solid rgba(226,232,240,0.9);
    backdrop-filter: blur(18px);
    padding: 22px 22px 24px;
    position: relative;
    overflow: hidden;
  }

  .admin-shell::before {
    content: "";
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at top right, rgba(56,189,248,0.18), transparent 60%);
    opacity: 0.9;
    pointer-events: none;
  }

  .admin-inner {
    position: relative;
    z-index: 1;
  }

  /* Floating logout */
  .logout-btn-floating {
    position: fixed;
    top: 90px;
    right: 24px;
    z-index: 2000;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    border-radius: 999px;
    padding: 8px 16px;
    font-size: 0.9rem;
    font-weight: 600;
    background: linear-gradient(135deg, #ef4444, #b91c1c);
    color: #ffffff;
    text-decoration: none;
    box-shadow: 0 10px 30px rgba(248,113,113,0.55);
    backdrop-filter: blur(12px);
    transition: all 0.25s ease;
  }
  .logout-btn-floating:hover {
    transform: translateY(-2px) scale(1.03);
    background: linear-gradient(135deg, #dc2626, #7f1d1d);
    box-shadow: 0 12px 34px rgba(239,68,68,0.65);
  }

  /* Header */
  .admin-header {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    margin-bottom: 20px;
  }

  .admin-title-block h2 {
    margin: 0;
    font-weight: 800;
    font-size: 1.45rem;
    color: #0f172a;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .admin-title-block h2 span.icon {
    font-size: 1.7rem;
  }

  .admin-subtitle {
    margin: 2px 0 0;
    font-size: 0.85rem;
    color: #6b7280;
  }

  /* Stats cards grid */
  .dashboard-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
    gap: 18px;
    margin-top: 6px;
    margin-bottom: 24px;
  }

  .card-box {
    background: linear-gradient(145deg, #ffffff, #f9fafb);
    border-radius: 18px;
    padding: 18px 18px 16px;
    text-align: left;
    box-shadow: 0 10px 30px rgba(15,23,42,0.12);
    transition: transform 0.22s ease, box-shadow 0.22s ease, border-color 0.22s ease;
    border: 1px solid rgba(226,232,240,0.9);
    position: relative;
    overflow: hidden;
  }

  .card-box::before {
    content: "";
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at top left, rgba(34,197,94,0.16), transparent 60%);
    opacity: 0;
    transition: opacity 0.25s ease;
  }

  .card-box:hover {
    transform: translateY(-5px);
    box-shadow: 0 16px 40px rgba(15,23,42,0.22);
    border-color: rgba(56,189,248,0.55);
    background: #ffffff;
  }

  .card-box:hover::before {
    opacity: 1;
  }

  .card-label {
    font-size: 0.86rem;
    font-weight: 600;
    color: #0f766e;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .card-label span.emoji {
    font-size: 1.1rem;
  }

  .card-value {
    font-size: 1.9rem;
    color: #0f172a;
    margin: 8px 0 0;
    font-weight: 800;
  }

  .card-sub {
    margin-top: 4px;
    font-size: 0.78rem;
    color: #6b7280;
  }

  .card-link-wrapper {
    text-decoration: none;
    color: inherit;
  }

  /* Manage users card narrower center */
  .manage-users-wrapper {
    max-width: 320px;
    margin: 4px auto 10px;
  }

  /* Sections */
  .section {
    background: rgba(255,255,255,0.98);
    border-radius: 18px;
    padding: 18px 18px 16px;
    box-shadow: 0 10px 28px rgba(15,23,42,0.12);
    margin-top: 12px;
  }

  .section-title {
    font-weight: 700;
    color: #0f766e;
    margin-bottom: 10px;
    text-align: center;
    font-size: 1.05rem;
  }

  .section-title span.icon {
    margin-right: 4px;
  }

  .section-sub {
    text-align: center;
    font-size: 0.8rem;
    color: #6b7280;
    margin-bottom: 10px;
  }

  .table-wrapper {
    width: 100%;
    overflow-x: auto;
  }

  .table {
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 0;
  }

  .table thead {
    background: #0f766e;
    color: white;
  }
  .table thead th {
    border-bottom: none;
    font-size: 0.85rem;
  }
  .table tbody tr {
    font-size: 0.88rem;
  }

  canvas {
    max-height: 320px;
  }

  /* Responsive tweaks */
  @media (max-width: 992px) {
    .admin-shell {
      padding: 18px 14px 18px;
    }
    .logout-btn-floating {
      top: 84px;
      right: 14px;
      padding: 7px 13px;
    }
  }

  @media (max-width: 576px) {
    .logout-btn-floating {
      font-size: 0.78rem;
      right: 8px;
    }
  }
</style>

<!-- Floating Logout -->
<a href="{% url 'logout' %}" class="logout-btn-floating">
  üö™ Logout
</a>

<div class="admin-page">
  <div class="admin-shell">
    <div class="admin-inner">

      <!-- HEADER -->
      <div class="admin-header">
        <div class="admin-title-block">
          <h2 class="animate__animated animate__fadeInDown">
            <span class="icon">üìä</span>
            <span>Admin Analytics Dashboard</span>
          </h2>
          <p class="admin-subtitle">
            High-level overview of users, doctors, pharmacies, and appointments across the platform.
          </p>
        </div>
      </div>

      <!-- STATS CARDS -->
      <div class="dashboard-cards">
        <!-- Total Users -->
        <div class="card-box animate__animated animate__fadeInUp">
          <div class="card-label">
            <span class="emoji">üë•</span>
            <span>Total Users</span>
          </div>
          <div class="card-value" id="countUsers">{{ total_users }}</div>
          <div class="card-sub">Registered across all roles</div>
        </div>

        <!-- Patients -->
        <a href="{% url 'view_all_patients' %}" class="card-link-wrapper">
          <div class="card-box animate__animated animate__fadeInUp">
            <div class="card-label">
              <span class="emoji">üßç‚Äç‚ôÄÔ∏è</span>
              <span>Total Patients</span>
            </div>
            <div class="card-value" id="countPatients">{{ total_patients }}</div>
            <div class="card-sub">Click to view all patients</div>
          </div>
        </a>

        <!-- Doctors -->
        <a href="{% url 'view_all_doctors' %}" class="card-link-wrapper">
          <div class="card-box animate__animated animate__fadeInUp">
            <div class="card-label">
              <span class="emoji">ü©∫</span>
              <span>Total Doctors</span>
            </div>
            <div class="card-value" id="countDoctors">{{ total_doctors }}</div>
            <div class="card-sub">Click to view all doctors</div>
          </div>
        </a>

        <!-- Pharmacies -->
        <a href="{% url 'view_all_pharmacies' %}" class="card-link-wrapper">
          <div class="card-box animate__animated animate__fadeInUp">
            <div class="card-label">
              <span class="emoji">üè™</span>
              <span>Total Pharmacies</span>
            </div>
            <div class="card-value" id="countPharmacies">{{ total_pharmacies }}</div>
            <div class="card-sub">Partner pharmacy accounts</div>
          </div>
        </a>

        <!-- Appointments -->
        <div class="card-box animate__animated animate__fadeInUp">
          <div class="card-label">
            <span class="emoji">üìÖ</span>
            <span>Total Appointments</span>
          </div>
          <div class="card-value" id="countAppointments">{{ total_appointments }}</div>
          <div class="card-sub">All-time appointment count</div>
        </div>
      </div>

      <!-- Manage Users card (centered) -->
      <div class="manage-users-wrapper">
        <a href="{% url 'manage_users' %}" class="card-link-wrapper">
          <div class="card-box text-center animate__animated animate__fadeInUp">
            <div class="card-label justify-content-center">
              <span class="emoji">‚öôÔ∏è</span>
              <span>Manage Users</span>
            </div>
            <div class="card-value" style="font-size:1.3rem;margin-top:6px;">Admin Tools</div>
            <div class="card-sub">View, edit, or deactivate accounts</div>
          </div>
        </a>
      </div>

      <!-- Appointment Status Chart -->
      <div class="section mt-3">
        <h3 class="section-title">
          <span class="icon">üìÖ</span> Appointment Status Overview
        </h3>
        <p class="section-sub">
          Distribution of appointments by status across the platform.
        </p>
        <canvas id="appointmentChart"></canvas>
      </div>

      <!-- Most Active Doctors -->
      <div class="section mt-4">
        <h3 class="section-title">
          <span class="icon">üè•</span> Most Active Doctors
        </h3>
        <div class="table-wrapper">
          <table class="table table-striped text-center align-middle">
            <thead>
              <tr>
                <th>Doctor</th>
                <th>Appointments</th>
              </tr>
            </thead>
            <tbody>
              {% for doc in top_doctors %}
                <tr>
                  <td>{{ doc.doctor__username }}</td>
                  <td>{{ doc.count }}</td>
                </tr>
              {% empty %}
                <tr><td colspan="2">No data available</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Most Active Patients -->
      <div class="section mt-4">
        <h3 class="section-title">
          <span class="icon">üë•</span> Most Active Patients
        </h3>
        <div class="table-wrapper">
          <table class="table table-striped text-center align-middle">
            <thead>
              <tr>
                <th>Patient</th>
                <th>Appointments</th>
              </tr>
            </thead>
            <tbody>
              {% for pat in top_patients %}
                <tr>
                  <td>{{ pat.patient__username }}</td>
                  <td>{{ pat.count }}</td>
                </tr>
              {% empty %}
                <tr><td colspan="2">No data available</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const animateCounter = (id, endVal) => {
    const el = document.getElementById(id);
    if (!el) return;
    let start = 0;
    const duration = 1500;
    const step = endVal / (duration / 16);
    const counter = setInterval(() => {
      start += step;
      if (start >= endVal) {
        el.textContent = endVal;
        clearInterval(counter);
      } else {
        el.textContent = Math.floor(start);
      }
    }, 16);
  };

  animateCounter('countUsers', {{ total_users }});
  animateCounter('countPatients', {{ total_patients }});
  animateCounter('countDoctors', {{ total_doctors }});
  animateCounter('countPharmacies', {{ total_pharmacies }});
  animateCounter('countAppointments', {{ total_appointments }});

  const ctx = document.getElementById('appointmentChart');
  if (ctx) {
    new Chart(ctx, {
      type: 'pie',
      data: {
        labels: [{% for s in appointments_by_status %}'{{ s.status }}',{% endfor %}],
        datasets: [{
          data: [{% for s in appointments_by_status %}{{ s.count }},{% endfor %}],
          backgroundColor: ['#22c55e', '#3b82f6', '#f97316', '#ef4444', '#6366f1'],
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'bottom',
            labels: { font: { size: 12 } }
          }
        }
      }
    });
  }
});
</script>

{% endblock %}
