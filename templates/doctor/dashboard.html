{% extends 'base.html' %}
{% load static %}
{% block title %}Doctor Dashboard{% endblock %}
{% block content %}

<style>
body {
  background: radial-gradient(circle at top left, #e0f7fa 0%, #f9fafb 40%, #ecfeff 85%);
  font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  overflow-x: hidden;
}

/* üè• Page shell */
.doctor-page {
  min-height: calc(100vh - 80px);
  padding: 32px 12px 40px;
}

.doctor-shell {
  max-width: 1120px;
  margin: 0 auto;
  background: rgba(255,255,255,0.97);
  border-radius: 24px;
  box-shadow: 0 22px 55px rgba(15,23,42,0.16);
  border: 1px solid rgba(226,232,240,0.9);
  backdrop-filter: blur(18px);
  padding: 22px 22px 20px;
  position: relative;
  overflow: hidden;
}

.doctor-shell::before {
  content: "";
  position: absolute;
  inset: 0;
  background: radial-gradient(circle at top right, rgba(45,212,191,0.18), transparent 60%);
  opacity: 0.9;
  pointer-events: none;
}

.doctor-inner {
  position: relative;
  z-index: 1;
}

/* ‚ú® Floating Logout Button */
.logout-btn {
  position: fixed;
  top: 90px;
  right: 30px;
  z-index: 2000;
  display: flex;
  align-items: center;
  gap: 8px;
  background: linear-gradient(135deg, #14b8a6, #0d9488);
  color: white;
  border: none;
  border-radius: 999px;
  padding: 9px 18px;
  font-weight: 600;
  font-size: 0.9rem;
  box-shadow: 0 8px 25px rgba(13, 148, 136, 0.35);
  backdrop-filter: blur(12px);
  text-decoration: none;
  transition: all 0.25s ease;
}
.logout-btn:hover {
  transform: translateY(-2px) scale(1.03);
  background: linear-gradient(135deg, #0d9488, #115e59);
  box-shadow: 0 12px 30px rgba(13, 148, 136, 0.4);
}
.logout-btn i {
  font-size: 1rem;
}

/* HEADER / PROFILE CARD */
.profile-card {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  align-items: center;
  gap: 18px;
  padding: 18px 20px;
  border-radius: 20px;
  background: linear-gradient(135deg, #ecfdf5, #e0f2fe);
  box-shadow: 0 10px 30px rgba(15,23,42,0.12);
  margin-bottom: 20px;
  animation: fadeUp 0.8s ease;
}

@keyframes fadeUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.profile-left {
  display: flex;
  align-items: center;
  gap: 14px;
}

.profile-avatar {
  width: 54px;
  height: 54px;
  border-radius: 999px;
  background: #0f766e;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #ecfdf5;
  font-weight: 800;
  font-size: 1.25rem;
  box-shadow: 0 10px 24px rgba(15,118,110,0.35);
}

.profile-info h3 {
  color: #0f172a;
  font-weight: 800;
  font-size: 1.35rem;
  margin-bottom: 2px;
  display: flex;
  align-items: center;
  gap: 6px;
}
.profile-info h3 span.icon {
  font-size: 1.4rem;
}

.profile-info p {
  margin: 2px 0;
  color: #374151;
  font-size: 0.9rem;
}

.profile-tags {
  margin-top: 6px;
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}

.tag-pill {
  font-size: 0.7rem;
  padding: 2px 8px;
  border-radius: 999px;
  background: rgba(15,118,110,0.08);
  color: #0f766e;
  border: 1px solid rgba(45,212,191,0.35);
}

/* Lottie container */
.profile-anim {
  width: 170px;
  height: 170px;
  animation: float 3s ease-in-out infinite;
}

@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-8px); }
}

/* APPOINTMENTS WRAPPER */
.appointments-section {
  margin-top: 6px;
  padding: 16px 14px 12px;
  border-radius: 18px;
  background: rgba(255,255,255,0.96);
  box-shadow: 0 12px 30px rgba(15,23,42,0.10);
}

.appointments-header {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 8px;
}

.appointments-title {
  margin: 0;
  font-size: 1.1rem;
  font-weight: 700;
  color: #0f766e;
  display: flex;
  align-items: center;
  gap: 6px;
}

.appointments-sub {
  font-size: 0.78rem;
  color: #6b7280;
}

/* Small status chips on right */
.appointment-stats {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}
.appointment-stat-pill {
  font-size: 0.7rem;
  padding: 3px 8px;
  border-radius: 999px;
  background: #f9fafb;
  color: #4b5563;
  border: 1px solid #e5e7eb;
}

/* Table styling */
.table-wrapper {
  width: 100%;
  overflow-x: auto;
  margin-top: 6px;
}

.table {
  margin-bottom: 0;
  border-radius: 12px;
  overflow: hidden;
}

.table thead {
  background: #0d9488;
  color: #ffffff;
}

.table thead th {
  border-bottom: none;
  font-size: 0.86rem;
}

.table tbody tr {
  font-size: 0.88rem;
}
.table tbody tr:hover {
  background-color: #f1f5f9;
}

.table td, .table th {
  vertical-align: middle;
}

/* Button spacing inside table */
.appointment-actions form {
  display: inline-block;
  margin: 0 2px;
}
.appointment-actions a.btn {
  margin: 0 2px;
}

/* Responsive tweaks */
@media (max-width: 992px) {
  .doctor-shell {
    padding: 18px 16px 16px;
  }
  .logout-btn {
    top: 82px;
    right: 16px;
    padding: 8px 14px;
  }
}

@media (max-width: 768px) {
  .profile-card {
    flex-direction: column;
    align-items: flex-start;
  }
  .profile-anim {
    align-self: center;
  }
  .doctor-page {
    padding-top: 22px;
  }
}

@media (max-width: 576px) {
  .logout-btn {
    font-size: 0.8rem;
    padding: 7px 12px;
    right: 10px;
  }
}
</style>

<!-- Floating Logout -->
<a href="{% url 'logout' %}" class="logout-btn">
  <i class="bi bi-box-arrow-right"></i> Logout
</a>

<div class="doctor-page">
  <div class="doctor-shell">
    <div class="doctor-inner">

      <!-- PROFILE / HEADER -->
      <div class="profile-card">
        <div class="profile-left">
          <div class="profile-avatar">
            {{ request.user.username|slice:":1"|upper }}
          </div>
          <div class="profile-info">
            <h3>
              <span class="icon">üë®‚Äç‚öïÔ∏è</span>
              <span>Dr. {{ request.user.username }}</span>
            </h3>

            {% if profile %}
              <p><strong>Specialization:</strong> {{ profile.specialty }}</p>
              <p><strong>Consultation Fee:</strong> ‚Çπ{{ profile.fees }}</p>
              <p><strong>Clinic Address:</strong> {{ profile.address }}</p>

              <div class="profile-tags">
                <span class="tag-pill">Online Consultations</span>
                <span class="tag-pill">Secure Chat Enabled</span>
              </div>

              <!-- ‚úèÔ∏è Edit Profile button added -->
              <a href="{% url 'edit_doctor_profile' %}" class="btn btn-sm btn-outline-success mt-2">
                ‚úèÔ∏è Edit Profile
              </a>

            {% else %}
              <p class="text-muted mb-0">Profile details not found.</p>
            {% endif %}
          </div>
        </div>

        <!-- Lottie Animation -->
        <div class="profile-anim" id="doctorAnim"></div>
      </div>

      <!-- APPOINTMENTS SECTION -->
      <div class="appointments-section">
        <div class="appointments-header">
          <div>
            <h4 class="appointments-title">üóìÔ∏è Your Appointments</h4>
            <div class="appointments-sub">
              Manage approvals, complete consultations, and chat with patients.
            </div>
          </div>

          <div class="d-flex flex-column align-items-end gap-1">
            <div class="appointment-stats">
              <span class="appointment-stat-pill">Pending / Approved / Completed at a glance</span>
            </div>
            <form method="POST"
                  action="{% url 'clear_completed_doctor' %}"
                  onsubmit="return confirm('Clear all completed appointments?');">
              {% csrf_token %}
              <button type="submit" class="btn btn-sm btn-outline-secondary">
                üßπ Clear Completed / Rejected / Cancelled
              </button>
            </form>
          </div>
        </div>

        <div class="table-wrapper">
          <table class="table table-striped text-center align-middle">
            <thead>
              <tr>
                <th>Patient Name</th>
                <th>Date</th>
                <th>Status</th>
                <th style="min-width: 210px;">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for appointment in appointments %}
              <tr>
                <td>{{ appointment.patient.username }}</td>
                <td>{{ appointment.date }}</td>
                <td>
                  {% if appointment.status == 'Pending' %}
                    <span class="badge bg-warning text-dark">Pending</span>
                  {% elif appointment.status == 'Approved' %}
                    <span class="badge bg-success">Approved</span>
                  {% elif appointment.status == 'Rejected' %}
                    <span class="badge bg-danger">Rejected</span>
                  {% elif appointment.status == 'Completed' %}
                    <span class="badge bg-primary">Completed</span>
                  {% else %}
                    <span class="badge bg-secondary">{{ appointment.status }}</span>
                  {% endif %}
                </td>

                <td class="appointment-actions">
                  {% if appointment.status == 'Pending' %}
                    <form method="POST"
                          action="{% url 'manage_appointment' appointment.id 'approve' %}">
                      {% csrf_token %}
                      <button class="btn btn-success btn-sm">Approve</button>
                    </form>

                    <form method="POST"
                          action="{% url 'manage_appointment' appointment.id 'cancel' %}">
                      {% csrf_token %}
                      <button class="btn btn-danger btn-sm">Cancel</button>
                    </form>

                  {% elif appointment.status == 'Approved' %}
                    <form method="POST"
                          action="{% url 'manage_appointment' appointment.id 'complete' %}">
                      {% csrf_token %}
                      <button class="btn btn-primary btn-sm">Complete</button>
                    </form>

                    <a href="{% url 'chat_with_doctor' appointment.id %}"
                       class="btn btn-info btn-sm ms-1">
                      üí¨ Chat
                    </a>

                  {% else %}
                    <span class="text-muted">{{ appointment.status }}</span>
                  {% endif %}
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="4" class="text-muted py-3">
                  No appointments yet.
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Lottie Animation Script -->
<script src="https://unpkg.com/lottie-web@5.9.6/build/player/lottie.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    lottie.loadAnimation({
      container: document.getElementById('doctorAnim'),
      renderer: 'svg',
      loop: true,
      autoplay: true,
      path: "{% static 'lottie/fd.json' %}"
    });
  });
</script>

{% endblock %}
