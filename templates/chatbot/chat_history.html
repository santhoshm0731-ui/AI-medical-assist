{% extends 'base.html' %}
{% block title %}Chat History{% endblock %}
{% block content %}

<style>
body {
  background: radial-gradient(circle at top left, #d9f0ff 0%, #ffffff 40%, #f1f5f9 85%);
  font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
}

/* PAGE LAYOUT */
.history-page {
  min-height: calc(100vh - 80px);
  padding: 28px 0 40px;
}

.history-container {
  max-width: 1100px;
}

/* Back button */
#back-btn {
  transition: all 0.25s ease;
  border-radius: 999px;
}

#back-btn:hover {
  background-color: #e9ecef;
  transform: translateY(-2px);
}

/* Main card wrapper */
.history-card-wrapper {
  background: rgba(255, 255, 255, 0.97);
  backdrop-filter: blur(16px);
  border-radius: 22px;
  box-shadow: 0 18px 44px rgba(15, 23, 42, 0.16);
  border: 1px solid rgba(226, 232, 240, 0.9);
  padding: 22px 22px 20px;
  position: relative;
  overflow: hidden;
}

.history-card-wrapper::before {
  content: "";
  position: absolute;
  inset: 0;
  background: radial-gradient(circle at top right, rgba(56,189,248,0.16), transparent 60%);
  opacity: 0.9;
  pointer-events: none;
}

.history-inner {
  position: relative;
  z-index: 1;
}

/* Header row */
.history-header-row {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
  margin-bottom: 16px;
}

.history-title-wrap {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.history-title-wrap h3 {
  font-weight: 800;
  color: #0f172a;
  margin: 0;
  font-size: 1.4rem;
}

.history-subtitle {
  font-size: 0.85rem;
  color: #6b7280;
}

.history-actions .btn {
  border-radius: 999px;
  font-size: 0.8rem;
}

/* Chat cards */
.chat-card {
  transition: transform 0.18s ease, box-shadow 0.25s ease, opacity 0.4s ease;
  border-radius: 16px;
  border: 1px solid #e5e7eb;
}

.chat-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 26px rgba(15, 23, 42, 0.12);
}

.chat-card .card-body {
  padding: 14px 14px 10px;
}

/* Chat content */
.chat-user-row,
.chat-bot-row {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
}

.chat-user-row {
  margin-bottom: 4px;
}

.chat-user-main,
.chat-bot-main {
  flex: 1;
}

.chat-label {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: 0.78rem;
  font-weight: 600;
  padding: 3px 8px;
  border-radius: 999px;
}

.chat-label.user {
  background: rgba(59,130,246,0.1);
  color: #1d4ed8;
}

.chat-label.bot {
  background: rgba(16,185,129,0.1);
  color: #047857;
}

.chat-text {
  display: inline-block;
  margin-left: 6px;
  font-size: 0.9rem;
  color: #111827;
}

.chat-timestamp {
  font-size: 0.78rem;
  color: #6b7280;
  margin-top: 6px;
}

/* Single delete button */
.delete-msg.btn {
  border-radius: 999px;
}

/* Fade-out animation */
.fade-out {
  opacity: 0;
}

/* Empty / info alert */
.history-empty {
  margin-top: 40px;
}

/* Modal buttons */
.modal-footer .btn {
  border-radius: 999px;
}

/* Responsive tweaks */
@media (max-width: 576px) {
  .history-card-wrapper {
    padding: 18px 14px 16px;
    border-radius: 18px;
  }
}
</style>

<div class="history-page">
  <!-- ðŸ”™ Back Button above main container -->
  <div class="text-start mt-2 ms-3 mb-2">
    <button type="button" id="back-btn" class="btn btn-outline-secondary btn-sm">
      <i class="bi bi-arrow-left"></i> Back to Chatbot
    </button>
  </div>

  <div class="container history-container">
    <div class="history-card-wrapper">
      <div class="history-inner">
        <div class="history-header-row">
          <div class="history-title-wrap">
            <h3 class="mb-0">
              <i class="bi bi-clock-history text-primary me-1"></i> Chat History
            </h3>
            <p class="history-subtitle mb-0">
              Review, download, or clear your previous conversations with the AI assistant.
            </p>
          </div>
          <div class="history-actions">
            <button id="download-history" class="btn btn-outline-success btn-sm me-1">
              <i class="bi bi-download"></i> Download
            </button>
            <button class="btn btn-outline-danger btn-sm" id="open-delete-all-modal">
              <i class="bi bi-trash"></i> Delete All
            </button>
          </div>
        </div>

        {% if history %}
        <div id="chat-history-list" class="row gy-3">
          {% for chat in history %}
          <div class="col-12">
            <div class="card shadow-sm chat-card border-0 rounded-4" id="chat-{{ chat.id }}">
              <div class="card-body">
                <!-- User row -->
                <div class="chat-user-row mb-1">
                  <div class="chat-user-main">
                    <span class="chat-label user">
                      <i class="bi bi-person-fill"></i> You
                    </span>
                    <span class="chat-text">{{ chat.message }}</span>
                  </div>
                  <button
                    class="btn btn-sm btn-outline-danger delete-msg"
                    data-id="{{ chat.id }}"
                    data-bs-toggle="modal"
                    data-bs-target="#confirmDeleteModal"
                    title="Delete this message"
                  >
                    <i class="bi bi-trash"></i>
                  </button>
                </div>

                <!-- Bot row -->
                <div class="chat-bot-row mb-1">
                  <div class="chat-bot-main">
                    <span class="chat-label bot">
                      <i class="bi bi-robot"></i> Bot
                    </span>
                    <span class="chat-text">{{ chat.response }}</span>
                  </div>
                </div>

                <!-- Timestamp -->
                <div class="chat-timestamp">
                  <i class="bi bi-clock"></i>
                  {{ chat.timestamp|date:"M d, Y, g:i A" }}
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="alert alert-info text-center shadow-sm rounded-3 history-empty">
          <i class="bi bi-info-circle"></i> No chat history found yet.
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- âœ… Delete Single Message Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-danger text-white rounded-top-3">
        <h5 class="modal-title" id="confirmDeleteLabel">Confirm Deletion</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="mb-0">Are you sure you want to delete this message? This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="confirm-delete-btn" class="btn btn-danger">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- âœ… Delete All Confirmation Modal -->
<div class="modal fade" id="deleteAllModal" tabindex="-1" aria-labelledby="deleteAllLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-danger text-white rounded-top-3">
        <h5 class="modal-title" id="deleteAllLabel">Delete All Chats</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="mb-0">This will permanently delete <strong>all your chat history</strong>. Continue?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="confirm-delete-all-btn" class="btn btn-danger">Delete All</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS (if not already included in base.html) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {

  // ðŸ”™ Back Button Functionality
  const backBtn = document.getElementById("back-btn");
  if (backBtn) {
    backBtn.addEventListener("click", function() {
      // Keep your existing redirect
      window.location.href = "/chatbot/";
    });
  }

  // ðŸ—‘ Single message delete setup
  let deleteChatId = null;
  document.querySelectorAll(".delete-msg").forEach(btn => {
    btn.addEventListener("click", () => {
      deleteChatId = btn.getAttribute("data-id");
    });
  });

  // Confirm single delete
  document.getElementById("confirm-delete-btn").addEventListener("click", async () => {
    if (!deleteChatId) return;
    const csrfToken = "{{ csrf_token }}";
    const res = await fetch("{% url 'delete_chat_history' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": csrfToken,
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: new URLSearchParams({ chat_id: deleteChatId })
    });
    const data = await res.json();
    if (data.status === "success") {
      const card = document.getElementById(`chat-${deleteChatId}`);
      if (card) {
        card.classList.add("fade-out");
        setTimeout(() => card.remove(), 400);
      }
    }
    bootstrap.Modal.getInstance(document.getElementById("confirmDeleteModal")).hide();
  });

  // ðŸ§¹ Delete All Chats
  document.getElementById("open-delete-all-modal").addEventListener("click", () => {
    new bootstrap.Modal(document.getElementById("deleteAllModal")).show();
  });

  document.getElementById("confirm-delete-all-btn").addEventListener("click", async () => {
    const csrfToken = "{{ csrf_token }}";
    const res = await fetch("{% url 'delete_chat_history' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": csrfToken,
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: new URLSearchParams({ chat_id: "all" })
    });
    const data = await res.json();
    if (data.status === "success") {
      const list = document.getElementById("chat-history-list");
      if (list) {
        list.innerHTML = `
          <div class='alert alert-success text-center mt-4 rounded-3'>
            ðŸ§¹ All chat history deleted.
          </div>`;
      }
    }
    bootstrap.Modal.getInstance(document.getElementById("deleteAllModal")).hide();
  });

  // ðŸ’¾ Download Chat History
  document.getElementById("download-history").addEventListener("click", () => {
    const cards = document.querySelectorAll(".chat-card");
    if (!cards.length) {
      alert("No chat history to download.");
      return;
    }

    const chats = Array.from(cards)
      .map(card => {
        const youBadge = card.querySelector(".chat-label.user");
        const youTextElem = youBadge ? youBadge.parentElement.querySelector(".chat-text") : null;
        const botBadge = card.querySelector(".chat-label.bot");
        const botTextElem = botBadge ? botBadge.parentElement.querySelector(".chat-text") : null;
        const timeElem = card.querySelector(".chat-timestamp");

        const you = youTextElem ? youTextElem.innerText : "";
        const bot = botTextElem ? botTextElem.innerText : "";
        const time = timeElem ? timeElem.innerText : "";

        return `You: ${you}\nBot: ${bot}\n${time}\n-------------------------\n`;
      })
      .join("\n");

    if (!chats.trim()) {
      alert("No chat history to download.");
      return;
    }

    const blob = new Blob([chats], { type: "text/plain" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "Chat_History.txt";
    a.click();
    URL.revokeObjectURL(url);
  });
});
</script>

{% endblock %}
