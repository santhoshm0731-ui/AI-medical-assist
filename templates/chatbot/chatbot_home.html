{% extends 'base.html' %}
{% block title %}AI Medical Chatbot{% endblock %}
{% block content %}

<div class="chatbot-page">
  <!-- ðŸ”™ Back Button -->
  <div class="text-start mb-3 ms-3 mt-2">
    <a href="{% url 'patient_dashboard' %}" class="btn btn-outline-secondary btn-sm shadow-sm rounded-pill">
      <i class="bi bi-arrow-left"></i> Back to Dashboard
    </a>
  </div>

  <div class="container chatbot-container">
    <div class="card shadow-lg border-0 rounded-4 chatbot-card">
      <!-- Header -->
      <div class="card-header bg-gradient-primary text-white rounded-top-4 d-flex flex-wrap justify-content-between align-items-center p-3 gap-2">
        <div class="text-start">
          <h4 class="fw-bold mb-0">ðŸ’¬ AI Medical Chatbot</h4>
          <small class="text-light">Ask any health-related question or describe your symptoms.</small>
        </div>
        <div class="d-flex align-items-center gap-2 ms-auto">
          <a href="{% url 'view_chat_history' %}" class="btn btn-light btn-sm shadow-sm rounded-pill">
            <i class="bi bi-clock-history"></i> History
          </a>
          <button id="open-clear-modal" class="btn btn-danger btn-sm shadow-sm rounded-pill">
            <i class="bi bi-trash"></i> Clear
          </button>
        </div>
      </div>

      <!-- Chat Window -->
      <div id="chat-box" class="card-body chat-box">
        <div class="text-center text-muted mt-5">
          ðŸ‘‹ Hi! Iâ€™m your AI medical assistant. How can I help you today?
        </div>
      </div>

      <!-- Footer -->
      <div class="card-footer bg-white border-0 pt-3">
        <form id="chat-form" class="d-flex align-items-center gap-2">
          {% csrf_token %}
          <input
            id="user-input"
            type="text"
            class="form-control rounded-pill shadow-sm"
            placeholder="Type your message..."
            required
            autocomplete="off"
          >
          <button class="btn btn-primary rounded-circle shadow-sm d-flex align-items-center justify-content-center" id="send-btn" type="submit">
            <i class="bi bi-send-fill"></i>
          </button>
          <button
            type="button"
            id="voice-toggle"
            class="btn btn-outline-primary rounded-circle shadow-sm d-flex align-items-center justify-content-center"
            title="Read last response aloud"
          >
            <i class="bi bi-volume-up-fill"></i>
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- ðŸ§¹ Clear Chat Modal -->
<div class="modal fade" id="clearChatModal" tabindex="-1" aria-labelledby="clearChatModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-danger text-white rounded-top-3">
        <h5 class="modal-title" id="clearChatModalLabel">
          <i class="bi bi-exclamation-triangle"></i> Confirm Clear
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <p>Are you sure you want to clear all chat history? This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="confirm-clear" class="btn btn-danger rounded-pill">Clear All</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- ===================== JS ===================== -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  const form = document.getElementById("chat-form");
  const input = document.getElementById("user-input");
  const chatBox = document.getElementById("chat-box");
  const voiceBtn = document.getElementById("voice-toggle");

  let lastBotMessage = ""; // store the last bot response

  // =============== Append Message ===============
  function appendMessage(sender, message) {
    const wrapper = document.createElement("div");
    wrapper.className = sender === "user" ? "mb-2 d-flex justify-content-end" : "mb-2 d-flex justify-content-start";

    const bubble = document.createElement("div");
    bubble.className = "chat-bubble " + sender;
    bubble.innerHTML = message;

    wrapper.appendChild(bubble);
    chatBox.appendChild(wrapper);
    chatBox.scrollTop = chatBox.scrollHeight;

    if (sender === "bot") {
      lastBotMessage = message.replace(/<[^>]*>?/gm, ''); // remove HTML tags
    }
  }

  // =============== Send Message ===============
  form.addEventListener("submit", async function(e) {
    e.preventDefault();
    const message = input.value.trim();
    if (!message) return;

    appendMessage("user", message);
    input.value = "";
    appendMessage("bot", "<i class='text-muted'>Typing...</i>");

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    try {
      const response = await fetch("{% url 'chatbot_reply' %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": csrfToken,
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: new URLSearchParams({ message })
      });

      const data = await response.json();
      chatBox.lastChild.remove();
      appendMessage("bot", data.response);
    } catch (error) {
      chatBox.lastChild.remove();
      appendMessage("bot", "âš ï¸ Error occurred. Please try again.");
      console.error(error);
    }
  });

  // =============== Manual Voice Output ===============
  voiceBtn.addEventListener("click", function() {
    if (!lastBotMessage) {
      alert("No recent bot message to speak yet!");
      return;
    }

    // Stop previous speech first
    window.speechSynthesis.cancel();

    const utterance = new SpeechSynthesisUtterance(lastBotMessage);
    utterance.lang = "en-US";
    utterance.rate = 1;
    utterance.pitch = 1;

    voiceBtn.classList.add("speaking");
    speechSynthesis.speak(utterance);

    utterance.onend = () => {
      voiceBtn.classList.remove("speaking");
    };
  });

  // =============== Clear Chat Confirmation ===============
  const openClearModal = document.getElementById("open-clear-modal");
  const confirmClear = document.getElementById("confirm-clear");

  openClearModal.addEventListener("click", function() {
    new bootstrap.Modal(document.getElementById("clearChatModal")).show();
  });

  confirmClear.addEventListener("click", async function() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const response = await fetch("{% url 'delete_chat_history' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": csrfToken,
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: new URLSearchParams({ chat_id: "all" })
    });

    const data = await response.json();
    if (data.status === "success") {
      chatBox.innerHTML = "<div class='text-center text-muted mt-5'>ðŸ§¹ Chat history cleared successfully.</div>";
    }
    bootstrap.Modal.getInstance(document.getElementById("clearChatModal")).hide();
  });
});
</script>

<!-- ===================== CSS ===================== -->
<style>
body {
  background: radial-gradient(circle at top left, #d9f0ff 0%, #ffffff 40%, #f1f5f9 85%);
  font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
}

.chatbot-page {
  min-height: calc(100vh - 80px);
  padding-bottom: 32px;
}

.chatbot-container {
  max-width: 960px;
}

/* Card */
.chatbot-card {
  background-color: #ffffff;
  overflow: hidden;
  border-radius: 24px;
}

/* Header gradient */
.bg-gradient-primary {
  background: linear-gradient(90deg, #0f766e, #0ea5e9);
}

/* Chat window */
.chat-box {
  height: 470px;
  overflow-y: auto;
  background-color: #f8fafc;
  padding: 18px 16px;
  border-top: 1px solid #e5e7eb;
  border-bottom: 1px solid #e5e7eb;
  scroll-behavior: smooth;
}

/* Chat bubbles */
.chat-bubble {
  display: inline-block;
  max-width: 80%;
  padding: 10px 14px;
  border-radius: 18px;
  line-height: 1.4;
  font-size: 0.95rem;
  animation: fadeIn 0.25s ease-in;
  word-wrap: break-word;
}

.chat-bubble.user {
  background: #0f766e;
  color: white;
  border-bottom-right-radius: 6px;
}

.chat-bubble.bot {
  background: #e2e8f0;
  color: #111827;
  border-bottom-left-radius: 6px;
}

/* Voice button state */
#voice-toggle {
  width: 40px;
  height: 40px;
  transition: all 0.3s ease;
}

#voice-toggle:hover {
  transform: scale(1.08);
}

#voice-toggle.speaking {
  background-color: #0d6efd;
  color: white;
  transform: scale(1.12);
  box-shadow: 0 0 15px rgba(13, 110, 253, 0.5);
}

/* Animations */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(5px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Responsive tweaks */
@media (max-width: 576px) {
  .chatbot-card {
    border-radius: 18px;
  }

  .chat-box {
    height: 420px;
  }
}
</style>

{% endblock %}
